"use client"

import type React from "react"
import { useState, useEffect, useRef, useCallback, memo } from "react"
import Image from "next/image"

interface Note {
  id: number
  position: string
  content: string
}

interface ImageData {
  id: number
  file_path: string
  original_name: string
}

interface AvatarData {
  id: number
  position: string
  file_path: string
}

const GalleryImage = memo(function GalleryImage({
  img,
  onDelete,
}: {
  img: ImageData
  onDelete: (id: number) => void
}) {
  return (
    <div
      className="rounded-2xl overflow-hidden transition-transform hover:-translate-y-1 relative group"
      style={{
        flex: "0 0 calc(33.33% - 6px)",
        aspectRatio: "1 / 1",
        boxShadow: "0 4px 10px rgba(255, 20, 120, 0.18)",
      }}
    >
      <Image
        src={img.file_path || "/placeholder.svg"}
        alt={img.original_name || "Gallery image"}
        fill
        sizes="(max-width: 400px) 100px, 120px"
        className="object-cover"
        loading="lazy"
      />
      <button
        onClick={() => onDelete(img.id)}
        className="absolute top-1 right-1 w-5 h-5 rounded-full bg-red-500 text-white text-xs opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center"
        title="Xóa ảnh"
      >
        ×
      </button>
    </div>
  )
})

const AvatarUpload = memo(function AvatarUpload({
  avatar,
  position,
  onUpload,
}: {
  avatar: string | null
  position: string
  onUpload: (e: React.ChangeEvent<HTMLInputElement>, position: string) => void
}) {
  return (
    <label
      className="w-[90px] h-[90px] sm:w-[110px] sm:h-[110px] rounded-full cursor-pointer flex items-center justify-center relative transition-transform hover:scale-105 flex-shrink-0 overflow-hidden"
      style={{
        border: "4px solid #ff80ab",
        boxShadow: "0 10px 24px rgba(255, 20, 120, 0.23)",
        background: avatar ? "transparent" : "#fce4ec",
      }}
    >
      {avatar ? (
        <Image
          src={avatar || "/placeholder.svg"}
          alt={`Avatar ${position}`}
          fill
          sizes="110px"
          className="object-cover"
          priority
        />
      ) : (
        <span
          className="text-[10px] sm:text-[11px] px-2 py-0.5 rounded-full"
          style={{ background: "rgba(255, 255, 255, 0.85)", color: "#ec407a" }}
        >
          Chọn ảnh
        </span>
      )}
      <input
        type="file"

        className="hidden"
        onChange={(e) => onUpload(e, position)}
      />
    </label>
  )
})

export default function HongPhanDiary() {
  const [date, setDate] = useState("")
  const [startDate, setStartDate] = useState<Date | null>(null)
  const [dayCount, setDayCount] = useState<number | null>(null)
  const [showDatePicker, setShowDatePicker] = useState(false)
  const [note1, setNote1] = useState("Hôm nay vui ♡")
  const [note2, setNote2] = useState("Yêu đời lắm!")
  const [avatar1, setAvatar1] = useState<string | null>(null)
  const [avatar2, setAvatar2] = useState<string | null>(null)
  const [galleryImages, setGalleryImages] = useState<ImageData[]>([])
  const [isLoading, setIsLoading] = useState(true)
  const galleryRef = useRef<HTMLDivElement>(null)
  const datePickerRef = useRef<HTMLInputElement>(null)

  const saveTimeoutRef = useRef<NodeJS.Timeout | null>(null)

  const calculateDays = useCallback((from: Date) => {
    const today = new Date()
    today.setHours(0, 0, 0, 0)
    const start = new Date(from)
    start.setHours(0, 0, 0, 0)
    const diffTime = today.getTime() - start.getTime()
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24))
    setDayCount(diffDays)
  }, [])

  const fetchData = useCallback(async () => {
    try {
      const [notesRes, avatarsRes, imagesRes, settingsRes] = await Promise.all([
        fetch("/api/notes"),
        fetch("/api/avatars"),
        fetch("/api/images"),
        fetch("/api/settings"),
      ])

      const [notes, avatars, images, settings] = await Promise.all([
        notesRes.ok ? notesRes.json() : [],
        avatarsRes.ok ? avatarsRes.json() : [],
        imagesRes.ok ? imagesRes.json() : [],
        settingsRes.ok ? settingsRes.json() : { startDate: null },
      ])

      // Process notes
      const leftNote = notes.find((n: Note) => n.position === "left")
      const rightNote = notes.find((n: Note) => n.position === "right")
      if (leftNote) setNote1(leftNote.content)
      if (rightNote) setNote2(rightNote.content)

      // Process avatars
      const leftAvatar = avatars.find((a: AvatarData) => a.position === "left")
      const rightAvatar = avatars.find((a: AvatarData) => a.position === "right")
      if (leftAvatar) setAvatar1(leftAvatar.file_path)
      if (rightAvatar) setAvatar2(rightAvatar.file_path)

      // Process images
      setGalleryImages(images)

      // Process start date from server
      if (settings.startDate) {
        const savedDate = new Date(settings.startDate)
        setStartDate(savedDate)
        calculateDays(savedDate)
      }
    } catch (error) {
      console.error("Error fetching data:", error)
    } finally {
      setIsLoading(false)
    }
  }, [calculateDays])

  useEffect(() => {
    fetchData()
  }, [fetchData])

  const handleDateSelect = useCallback(
    async (e: React.ChangeEvent<HTMLInputElement>) => {
      const selectedDate = new Date(e.target.value)
      setStartDate(selectedDate)
      calculateDays(selectedDate)
      setShowDatePicker(false)

      // Save to server
      try {
        await fetch("/api/settings", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ startDate: selectedDate.toISOString() }),
        })
      } catch (error) {
        console.error("Error saving start date:", error)
      }
    },
    [calculateDays],
  )

  const saveNote = useCallback(async (position: string, content: string) => {
    if (saveTimeoutRef.current) {
      clearTimeout(saveTimeoutRef.current)
    }
    saveTimeoutRef.current = setTimeout(async () => {
      try {
        await fetch("/api/notes", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ position, content }),
        })
      } catch (error) {
        console.error("Error saving note:", error)
      }
    }, 500)
  }, [])

  const handleAvatarUpload = useCallback(async (e: React.ChangeEvent<HTMLInputElement>, position: string) => {
    const file = e.target.files?.[0]
    if (!file) return

    const setter = position === "left" ? setAvatar1 : setAvatar2

    // Preview ngay lập tức
    const reader = new FileReader()
    reader.onload = (ev) => setter(ev.target?.result as string)
    reader.readAsDataURL(file)

    // Upload
    const formData = new FormData()
    formData.append("file", file)
    formData.append("position", position)

    try {
      const res = await fetch("/api/avatars", { method: "POST", body: formData })
      if (res.ok) {
        const data = await res.json()
        setter(data.path)
      }
    } catch (error) {
      console.error("Error uploading avatar:", error)
    }
  }, [])

  const uploadGalleryImages = useCallback(async (files: FileList) => {
    const uploadPromises = Array.from(files).map(async (file) => {
      if (!file.type.startsWith("image/")) return null

      const formData = new FormData()
      formData.append("file", file)

      try {
        const res = await fetch("/api/images", { method: "POST", body: formData })
        if (res.ok) return res.json()
      } catch (error) {
        console.error("Error uploading image:", error)
      }
      return null
    })

    await Promise.all(uploadPromises)

    // Fetch lại một lần sau khi upload xong
    const imagesRes = await fetch("/api/images")
    if (imagesRes.ok) {
      setGalleryImages(await imagesRes.json())
    }
  }, [])

  const handleGalleryAdd = useCallback(
    (e: React.ChangeEvent<HTMLInputElement>) => {
      if (e.target.files?.length) {
        uploadGalleryImages(e.target.files)
      }
      e.target.value = ""
    },
    [uploadGalleryImages],
  )

  const handleDrop = useCallback(
    (e: React.DragEvent) => {
      e.preventDefault()
      if (e.dataTransfer.files.length) {
        uploadGalleryImages(e.dataTransfer.files)
      }
    },
    [uploadGalleryImages],
  )

  const handleDeleteImage = useCallback(
    async (id: number) => {
      // Optimistic update
      setGalleryImages((prev) => prev.filter((img) => img.id !== id))

      try {
        await fetch("/api/images", {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id }),
        })
      } catch (error) {
        console.error("Error deleting image:", error)
        // Rollback nếu lỗi
        fetchData()
      }
    },
    [fetchData],
  )

  if (isLoading) {
    return (
      <div
        className="min-h-screen flex items-center justify-center"
        style={{ background: "radial-gradient(circle at top, #ffe4ef 0%, #fff0f8 40%, #ffeef4 100%)" }}
      >
        <div className="text-center" style={{ color: "#d81b60" }}>
          <div className="animate-spin w-10 h-10 border-4 border-pink-300 border-t-pink-600 rounded-full mx-auto mb-3" />
          <p>Đang tải...</p>
        </div>
      </div>
    )
  }

  return (
    <div
      className="min-h-screen flex items-center justify-center p-4"
      style={{ background: "radial-gradient(circle at top, #ffe4ef 0%, #fff0f8 40%, #ffeef4 100%)" }}
    >
      <div
        className="w-full max-w-[400px] min-h-[700px] sm:min-h-[820px] rounded-[44px] p-5 sm:p-6 pb-8 flex flex-col items-center gap-5 relative"
        style={{
          background: "rgba(255, 245, 250, 0.96)",
          boxShadow: "0 24px 70px rgba(255, 182, 193, 0.35)",
          border: "1px solid rgba(255, 230, 240, 0.8)",
          backdropFilter: "blur(10px)",
        }}
      >
        {/* Notch */}
        <div
          className="absolute top-3 left-1/2 -translate-x-1/2 w-[120px] h-[22px] rounded-full"
          style={{ background: "rgba(255, 240, 245, 0.9)", boxShadow: "inset 0 0 4px rgba(216, 27, 96, 0.25)" }}
        />

        {/* Header */}
        <header className="mt-4 text-center">
          <h1 className="text-xl font-bold tracking-wide" style={{ color: "#d81b60" }}>
            &lt; T và L &gt;
          </h1>
          <p className="text-xs mt-1" style={{ color: "#f06292" }}>
            Ghi lại những ảnh ngáo ngơ nhất
          </p>
        </header>

        <div
          className="w-[130px] h-[130px] sm:w-[140px] sm:h-[140px] rounded-full flex flex-col items-center justify-center font-semibold relative overflow-hidden cursor-pointer transition-transform hover:scale-105"
          style={{
            background: "radial-gradient(circle at top, #ffe0ec, #ffd1e3)",
            color: "#c2185b",
            boxShadow: "0 10px 25px rgba(216, 27, 96, 0.28)",
            border: "4px solid #ff99bb",
          }}
          onClick={() => {
            setShowDatePicker(true)
            setTimeout(() => datePickerRef.current?.showPicker(), 100)
          }}
        >
          <time className="text-[12px] sm:text-[13px] text-center leading-tight mb-1">{date}</time>
          {dayCount !== null ? (
            <div className="text-center">
              <span className="text-[28px] sm:text-[32px] tracking-wide leading-none">{dayCount}</span>
              <span className="block text-[10px] sm:text-[11px] mt-0.5 opacity-80">ngày bên nhau</span>
            </div>
          ) : (
            <div className="text-center px-2">
              <span className="text-[11px] sm:text-[12px]">Chạm để chọn ngày bắt đầu</span>
            </div>
          )}
          {/* Hidden date picker */}
          <input
            ref={datePickerRef}
            type="date"
            className="absolute opacity-0 pointer-events-none"
            onChange={handleDateSelect}
            max={new Date().toISOString().split("T")[0]}
          />
        </div>

        <div className="w-full grid grid-cols-2 gap-4 sm:gap-6 px-2">
          {/* Column 1 */}
          <div className="flex flex-col items-center">
            <div
              className="w-full min-h-[44px] sm:min-h-[48px] max-h-[100px] px-3 sm:px-4 py-2 rounded-2xl text-xs sm:text-sm text-center flex items-center justify-center outline-none overflow-y-auto"
              contentEditable
              suppressContentEditableWarning
              style={{
                background: "rgba(255, 240, 245, 0.96)",
                color: "#c2185b",
                boxShadow: "0 6px 16px rgba(255, 105, 180, 0.24)",
                border: "2px solid #ff80ab",
                backdropFilter: "blur(6px)",
                wordBreak: "break-word",
                overflowWrap: "break-word",
                whiteSpace: "pre-wrap",
              }}
              onBlur={(e) => {
                const content = e.currentTarget.textContent || ""
                setNote1(content)
                saveNote("left", content)
              }}
            >
              {note1}
            </div>
            <div
              className="w-3 h-3 sm:w-4 sm:h-4 rounded-full my-2 flex-shrink-0"
              style={{
                background: "rgba(255, 240, 245, 0.96)",
                border: "2px solid #ff80ab",
                boxShadow: "0 4px 10px rgba(255, 105, 180, 0.24)",
              }}
            />
            <AvatarUpload avatar={avatar1} position="left" onUpload={handleAvatarUpload} />
          </div>

          {/* Column 2 */}
          <div className="flex flex-col items-center">
            <div
              className="w-full min-h-[44px] sm:min-h-[48px] max-h-[100px] px-3 sm:px-4 py-2 rounded-2xl text-xs sm:text-sm text-center flex items-center justify-center outline-none overflow-y-auto"
              contentEditable
              suppressContentEditableWarning
              style={{
                background: "rgba(255, 240, 245, 0.96)",
                color: "#c2185b",
                boxShadow: "0 6px 16px rgba(255, 105, 180, 0.24)",
                border: "2px solid #ff80ab",
                backdropFilter: "blur(6px)",
                wordBreak: "break-word",
                overflowWrap: "break-word",
                whiteSpace: "pre-wrap",
              }}
              onBlur={(e) => {
                const content = e.currentTarget.textContent || ""
                setNote2(content)
                saveNote("right", content)
              }}
            >
              {note2}
            </div>
            <div
              className="w-3 h-3 sm:w-4 sm:h-4 rounded-full my-2 flex-shrink-0"
              style={{
                background: "rgba(255, 240, 245, 0.96)",
                border: "2px solid #ff80ab",
                boxShadow: "0 4px 10px rgba(255, 105, 180, 0.24)",
              }}
            />
            <AvatarUpload avatar={avatar2} position="right" onUpload={handleAvatarUpload} />
          </div>
        </div>

        {/* Gallery */}
        <section
          className="w-full min-h-[180px] sm:min-h-[200px] max-h-[280px] rounded-[28px] overflow-hidden flex flex-col"
          style={{
            background: "rgba(255, 245, 250, 0.9)",
            boxShadow: "inset 0 4px 15px rgba(255, 105, 180, 0.12)",
            border: "3px solid #ff99bb",
          }}
        >
          <header
            className="flex-shrink-0 py-2"
            style={{ background: "linear-gradient(to right, rgba(255, 220, 230, 0.8), rgba(255, 240, 250, 0.9))" }}
          >
            <h2 className="text-center font-semibold" style={{ color: "#d81b60" }}>
              Ảnh:))))
            </h2>
            <p className="text-center text-[11px]" style={{ color: "#ec407a" }}>
              Kéo thả hoặc bấm để thêm ảnh
            </p>
          </header>
          <div
            ref={galleryRef}
            className="flex-1 overflow-y-auto p-2.5 flex flex-wrap gap-2 content-start"
            onDragOver={(e) => e.preventDefault()}
            onDrop={handleDrop}
            style={{ scrollbarWidth: "thin", scrollbarColor: "#ff80ab #ffeef4" }}
          >
            <label
              className="cursor-pointer rounded-2xl flex items-center justify-center text-center text-[11px] p-1"
              style={{
                flex: "0 0 calc(33.33% - 6px)",
                aspectRatio: "1 / 1",
                border: "2px dashed rgba(255, 128, 171, 0.9)",
                color: "#ff80ab",
                background: "rgba(255, 255, 255, 0.92)",
              }}
            >
              <div>
                Thêm ảnh
                <br />
                <span className="text-[10px] opacity-80">(Click/kéo)</span>
              </div>
              <input
                type="file"
                accept="image/jpeg,image/jpg,image/png,image/gif,image/webp,image/bmp,image/svg+xml,image/heic,image/heif,image/avif,image/tiff,image/*"
                className="hidden"
                onChange={handleGalleryAdd}
                multiple
              />
            </label>
            {galleryImages.map((img) => (
              <GalleryImage key={img.id} img={img} onDelete={handleDeleteImage} />
            ))}
          </div>
        </section>
      </div>
    </div>
  )
}
